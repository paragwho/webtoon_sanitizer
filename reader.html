<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title></title>

<style>
  :root {
    --bg: #ffffff;
    --fg: #000000;
    --btn-bg: #f0f0f0;
    --btn-fg: #000000;
    --panel-bg: #ffffff;
    --border: #cccccc;
  }

  body.dark {
    --bg: #121212;
    --fg: #e0e0e0;
    --btn-bg: #1f1f1f;
    --btn-fg: #e0e0e0;
    --panel-bg: #1a1a1a;
    --border: #333333;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    display: flex;
    justify-content: center;
    font-family: system-ui, sans-serif;
  }

  .page {
    width: 100%;
    max-width: 800px;
  }

  img {
    width: 100%;
    display: block;
  }

  /* Controls */
  .controls {
    position: fixed;
    top: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.4rem;
    z-index: 10;
    align-items: center;
  }

  button, select {
    background: var(--btn-bg);
    color: var(--btn-fg);
    border: 1px solid var(--border);
    padding: 0.45rem 0.65rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
  }

  button:disabled {
    opacity: 0.4;
    cursor: default;
  }

  .icon-btn {
    border-radius: 8px;
    padding: 0.45rem;
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .icon-btn img {
    width: 18px;
    height: 18px;
    pointer-events: none;
    filter: invert(0);
  }

  /* Dark mode icon inversion */
  body.dark .icon-btn img {
    filter: invert(1);
  }

  .icon-btn:hover {
    background: rgba(0, 0, 0, 0.08);
  }

  body.dark .icon-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  /* Settings panel */
  .settings {
    position: fixed;
    top: 3.2rem;
    right: 1rem;
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.6rem;
    display: none;
    flex-direction: column;
    gap: 0.5rem;
    z-index: 20;
  }

  .settings label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    cursor: pointer;
  }
</style>
</head>

<body>
  <div class="page" id="page"></div>

  <div class="controls">
    <button id="prevEp" class="icon-btn" title="Previous episode">
      <img src="icons/arrow-left.svg" alt="">
    </button>

    <select id="episodeSelect" title="Select episode"></select>

    <button id="nextEp" class="icon-btn" title="Next episode">
      <img src="icons/arrow-right.svg" alt="">
    </button>

    <button id="topBtn" class="icon-btn" title="Top">
      <img src="icons/arrow-up.svg" alt="">
    </button>

    <button id="bottomBtn" class="icon-btn" title="Bottom">
      <img src="icons/arrow-down.svg" alt="">
    </button>

    <button id="settingsBtn" class="icon-btn" title="Settings">
      <img src="icons/settings.svg" alt="">
    </button>
  </div>

  <div class="settings" id="settingsPanel">
    <label>
      <input type="checkbox" id="darkToggle">
      Dark mode
    </label>
    <label>
      <input type="checkbox" id="smoothToggle">
      Smooth scroll
    </label>
  </div>

<script>
  // Set page title to parent folder name
  const pathParts = location.pathname.split("/").filter(Boolean);
  if (pathParts.length > 1) {
    document.title = decodeURIComponent(pathParts[pathParts.length - 2]);
  }

  const params = new URLSearchParams(location.search);

  // Default to EP1
  if (!params.has("ep")) {
    params.set("ep", "1");
    location.search = params.toString();
  }

  const epNum = parseInt(params.get("ep"), 10);
  const epFolder = `EP${epNum}_files`;

  const page = document.getElementById("page");
  const MAX_PAGES = 999;
  let lastImage = null;
  let stopped = false;

  for (let i = 1; i <= MAX_PAGES; i++) {
    if (stopped) break;

    const num = String(i).padStart(3, "0");
    const img = document.createElement("img");
    img.src = `${epFolder}/${num}.jpg`;
    img.loading = "lazy";

    img.onerror = () => {
      img.remove();
      stopped = true;
    };

    img.onload = () => lastImage = img;
    page.appendChild(img);
  }

  // Controls
  const prevBtn = document.getElementById("prevEp");
  const nextBtn = document.getElementById("nextEp");
  const topBtn = document.getElementById("topBtn");
  const bottomBtn = document.getElementById("bottomBtn");
  const settingsBtn = document.getElementById("settingsBtn");
  const settingsPanel = document.getElementById("settingsPanel");
  const episodeSelect = document.getElementById("episodeSelect");

  topBtn.onclick = () =>
    window.scrollTo({ top: 0, behavior: "smooth" });

  bottomBtn.onclick = () =>
    lastImage?.scrollIntoView({ behavior: "smooth" });

  const goToEpisode = n => {
    if (n < 1) return;
    params.set("ep", n);
    location.search = params.toString();
  };

  prevBtn.onclick = () => goToEpisode(epNum - 1);
  nextBtn.onclick = () => goToEpisode(epNum + 1);
  if (epNum <= 1) prevBtn.disabled = true;

  // Episode dropdown (auto-detect)
  let maxEpisode = 0;

  const detectEpisode = n => {
    return new Promise(resolve => {
      const img = new Image();
      img.onload = () => resolve(true);
      img.onerror = () => resolve(false);
      img.src = `EP${n}_files/001.jpg`;
    });
  };

  (async () => {
    for (let i = 1; i <= 999; i++) {
      const exists = await detectEpisode(i);
      if (!exists) break;
      maxEpisode = i;

      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = `EP ${i}`;
      episodeSelect.appendChild(opt);
    }

    episodeSelect.value = epNum;
    if (epNum >= maxEpisode) nextBtn.disabled = true;
  })();

  episodeSelect.onchange = () => {
    goToEpisode(parseInt(episodeSelect.value, 10));
  };

  // Settings
  const darkToggle = document.getElementById("darkToggle");
  const smoothToggle = document.getElementById("smoothToggle");

  let darkMode = localStorage.getItem("dark") === "1";
  let smoothScroll = localStorage.getItem("smooth") === "1";

  document.body.classList.toggle("dark", darkMode);
  darkToggle.checked = darkMode;
  smoothToggle.checked = smoothScroll;

  darkToggle.onchange = () => {
    darkMode = darkToggle.checked;
    document.body.classList.toggle("dark", darkMode);
    localStorage.setItem("dark", darkMode ? "1" : "0");
  };

  smoothToggle.onchange = () => {
    smoothScroll = smoothToggle.checked;
    localStorage.setItem("smooth", smoothScroll ? "1" : "0");
  };

  settingsBtn.onclick = () => {
    settingsPanel.style.display =
      settingsPanel.style.display === "flex" ? "none" : "flex";
  };

  // Close settings when clicking outside
  document.addEventListener("click", e => {
    if (
      settingsPanel.style.display === "flex" &&
      !settingsPanel.contains(e.target) &&
      !settingsBtn.contains(e.target)
    ) {
      settingsPanel.style.display = "none";
    }
  });

  // Keyboard
  document.addEventListener("keydown", e => {
    if (e.key === "ArrowDown") {
      e.preventDefault();
      window.scrollBy({
        top: smoothScroll ? 80 : window.innerHeight * 0.9,
        behavior: "smooth"
      });
    }

    if (e.key === "ArrowUp") {
      e.preventDefault();
      window.scrollBy({
        top: smoothScroll ? -80 : -window.innerHeight * 0.9,
        behavior: "smooth"
      });
    }

    if (e.key === " ") {
      e.preventDefault();
      window.scrollBy({
        top: window.innerHeight * 0.9,
        behavior: "smooth"
      });
    }

    if (e.key === "Home") {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    if (e.key === "End") {
      lastImage?.scrollIntoView({ behavior: "smooth" });
    }

    if (e.key === "ArrowLeft") prevBtn.click();
    if (e.key === "ArrowRight") nextBtn.click();

    if (e.key.toLowerCase() === "d") darkToggle.click();
    if (e.key.toLowerCase() === "s") smoothToggle.click();
    if (e.key === "Escape") settingsPanel.style.display = "none";
  });
</script>
</body>
</html>
